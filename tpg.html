<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Transaction Image Upload</title>
    <style>
        body {
            font-family: Arial, sans-serif;
        }
        #uploadForm {
            margin: 50px;
        }
        #resultModal {
            display: none;
            position: fixed;
            z-index: 1;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            justify-content: center;
            align-items: center;
        }
        #modalContent {
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            width: 400px;
            max-width: 90%;
        }
        .close {
            float: right;
            font-size: 20px;
            cursor: pointer;
        }
        #details {
            margin: 50px;
        }
    </style>
</head>
<body>

<h1>Upload Transaction Image</h1>

<form id="uploadForm" enctype="multipart/form-data">
    <input type="file" name="image" accept="image/*" required>
    <button type="submit">Upload</button>
</form>

<!-- Display extracted transaction details -->
<div id="details"></div>

<!-- Modal for showing transaction details -->
<div id="resultModal">
    <div id="modalContent">
        <span class="close" id="closeModal">&times;</span>
        <h3>Edit Transaction Details</h3>
        <form id="editForm">
            <input type="hidden" id="transaction-id" name="transaction-id">
            
            <label for="date">Date:</label>
            <input type="date" id="date" name="date" required><br><br>

            <label for="time">Time:</label>
            <input type="time" id="time" name="time" required><br><br>

            <label for="sender-receiver" id="senderReceiverLabel">Receiver:</label>
            <input type="text" id="sender-receiver" name="sender-receiver" required><br><br>

            <label for="amount">Amount:</label>
            <input type="text" id="amount" name="amount" required><br><br>

            <label for="status">Status:</label>
            <input type="text" id="status" name="status" readonly><br><br>

            <label for="category">Category:</label>
            <select id="category" name="category" required>
                <option value="">Select Category</option>
                <option value="Groceries">Groceries</option>
                <option value="Utilities">Utilities</option>
                <option value="Rent">Rent</option>
                <option value="Entertainment">Entertainment</option>
                <option value="Others">Others</option>
            </select><br><br>

            <button type="submit">Save Details</button>
        </form>
    </div>
</div>

<script>
    document.getElementById('uploadForm').addEventListener('submit', async function(event) {
        event.preventDefault();

        const formData = new FormData();
        const fileInput = document.querySelector('input[type="file"]');
        formData.append('image', fileInput.files[0]);

        try {
            const response = await fetch('/upload', {
                method: 'POST',
                body: formData
            });

            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.error || 'Error uploading image');
            }

            const data = await response.json();
            console.log("Extracted Data:", data); // Log the received data
            displayDetails(data);
            showModal(data);

        } catch (error) {
            alert('Error: ' + error.message);
        }
    });

    function displayDetails(data) {
        const detailsDiv = document.getElementById('details');
        let receiverOrSender = data.Receiver || data.Sender || 'N/A';
        let receiverOrSenderLabel = data.Status === 'Credited' ? 'Sender' : 'Receiver';

        detailsDiv.innerHTML = `
            <h3>Extracted Transaction Details:</h3>
            <p><strong>Date:</strong> ${data.Date || 'N/A'}</p>
            <p><strong>Time:</strong> ${data.Time || 'N/A'}</p>
            <p><strong>${receiverOrSenderLabel}:</strong> ${receiverOrSender}</p>
            <p><strong>Amount:</strong> ${data.Amount || 'N/A'}</p>
            <p><strong>Status:</strong> ${data.Status || 'N/A'}</p>
        `;
    }

    function showModal(data) {
        const resultModal = document.getElementById('resultModal');
        document.getElementById('transaction-id').value = data._id;
        document.getElementById('date').value = data.Date;  // Should be in YYYY-MM-DD format
        document.getElementById('time').value = data.Time;  // Should be in HH:MM format

        let receiverOrSender = data.Receiver || data.Sender || '';
        let receiverOrSenderLabel = data.Status === 'Credited' ? 'Sender' : 'Receiver';
        document.getElementById('sender-receiver').value = receiverOrSender;
        document.getElementById('senderReceiverLabel').textContent = receiverOrSenderLabel;

        document.getElementById('amount').value = data.Amount;
        document.getElementById('status').value = data.Status;
        document.getElementById('category').value = data.Category;

        resultModal.style.display = 'flex';
    }

    document.getElementById('closeModal').addEventListener('click', function() {
        document.getElementById('resultModal').style.display = 'none';
    });

    document.getElementById('editForm').addEventListener('submit', async function(event) {
        event.preventDefault();

        const formData = {
            _id: document.getElementById('transaction-id').value,
            Date: document.getElementById('date').value,
            Time: document.getElementById('time').value,
            Receiver: document.getElementById('sender-receiver').value,
            Amount: document.getElementById('amount').value,
            Status: document.getElementById('status').value,
            Category: document.getElementById('category').value
        };

        try {
            const response = await fetch('/save', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(formData)
            });

            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.error || 'Error saving transaction details');
            }

            const data = await response.json();
            alert(data.message);
            document.getElementById('resultModal').style.display = 'none';
        } catch (error) {
            alert('Error: ' + error.message);
        }
    });
</script>
</body> 
</html>
